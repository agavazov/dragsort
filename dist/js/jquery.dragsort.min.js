!function(a){a.fn.dragsort=function(b){if("destroy"==b)return void a(this.selector).trigger("dragsort-uninit");var c=a.extend({},a.fn.dragsort.defaults,b),d=[],e=null,f=null;return this.each(function(b,g){a(g).is("table")&&1==a(g).children().length&&a(g).children().is("tbody")&&(g=a(g).children().get(0));var h={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:g,init:function(){c.tagName=0==a(this.container).children().length?"li":a(this.container).children().get(0).tagName.toLowerCase(),""==c.itemSelector&&(c.itemSelector=c.tagName),""==c.dragSelector&&(c.dragSelector=c.tagName),""==c.placeHolderTemplate&&(c.placeHolderTemplate="<"+c.tagName+">&nbsp;</"+c.tagName+">"),a(this.container).attr("data-listidx",b).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit),this.styleDragHandlers(!0)},uninit:function(){var b=d[a(this).attr("data-listidx")];a(b.container).unbind("mousedown",b.grabItem).unbind("dragsort-uninit"),b.styleDragHandlers(!1)},getItems:function(){return a(this.container).children(c.itemSelector)},styleDragHandlers:function(b){this.getItems().map(function(){return a(this).is(c.dragSelector)?this:a(this).find(c.dragSelector).get()}).css("cursor",b?"pointer":"")},grabItem:function(b){var e=d[a(this).attr("data-listidx")],f=a(b.target).closest("[data-listidx] > "+c.tagName).get(0),g=e.getItems().filter(function(){return this==f}).length>0;if(!(1!=b.which||a(b.target).is(c.dragSelectorExclude)||a(b.target).closest(c.dragSelectorExclude).length>0)&&g){b.preventDefault();for(var h=b.target;!a(h).is(c.dragSelector);){if(h==this)return;h=h.parentNode}a(h).attr("data-cursor",a(h).css("cursor")),a(h).css("cursor","move");var i=this,j=function(){e.dragStart.call(i,b),a(e.container).unbind("mousemove",j)};a(e.container).mousemove(j).mouseup(function(){a(e.container).unbind("mousemove",j),a(h).css("cursor",a(h).attr("data-cursor"))})}},dragStart:function(b){null!=e&&null!=e.draggedItem&&e.dropItem(),e=d[a(this).attr("data-listidx")],e.draggedItem=a(b.target).closest("[data-listidx] > "+c.tagName),e.draggedItem.attr("data-origpos",a(this).attr("data-listidx")+"-"+a(e.container).children().index(e.draggedItem));var f=parseInt(e.draggedItem.css("marginTop")),g=parseInt(e.draggedItem.css("marginLeft"));if(e.offset=e.draggedItem.offset(),e.offset.top=b.pageY-e.offset.top+(isNaN(f)?0:f)-1,e.offset.left=b.pageX-e.offset.left+(isNaN(g)?0:g)-1,!c.dragBetween){var h=0==a(e.container).outerHeight()?Math.max(1,Math.round(.5+e.getItems().length*e.draggedItem.outerWidth()/a(e.container).outerWidth()))*e.draggedItem.outerHeight():a(e.container).outerHeight();e.offsetLimit=a(e.container).offset(),e.offsetLimit.right=e.offsetLimit.left+a(e.container).outerWidth()-e.draggedItem.outerWidth(),e.offsetLimit.bottom=e.offsetLimit.top+h-e.draggedItem.outerHeight()}var i=e.draggedItem.height(),j=e.draggedItem.width();if("tr"==c.tagName?(e.draggedItem.children().each(function(){a(this).width(a(this).width())}),e.placeHolderItem=e.draggedItem.clone().attr("data-placeholder",!0),e.draggedItem.after(e.placeHolderItem),e.placeHolderItem.children().each(function(){a(this).css({borderWidth:0,width:a(this).width()+1,height:a(this).height()+1}).html("&nbsp;")})):(e.draggedItem.after(c.placeHolderTemplate),e.placeHolderItem=e.draggedItem.next().css({height:i,width:j}).attr("data-placeholder",!0)),"td"==c.tagName){var k=e.draggedItem.closest("table").get(0);a("<table id='"+k.id+"' style='border-width: 0px;' class='dragSortItem "+k.className+"'><tr></tr></table>").appendTo("body").children().append(e.draggedItem)}var l=e.draggedItem.attr("style");e.draggedItem.attr("data-origstyle",l?l:""),e.draggedItem.css({position:"absolute",opacity:.8,"z-index":999,height:i,width:j}),e.scroll={moveX:0,moveY:0,maxX:a(document).width()-a(window).width(),maxY:a(document).height()-a(window).height()},e.scroll.scrollY=window.setInterval(function(){if(c.scrollContainer!=window)return void a(c.scrollContainer).scrollTop(a(c.scrollContainer).scrollTop()+e.scroll.moveY);var b=a(c.scrollContainer).scrollTop();(e.scroll.moveY>0&&b<e.scroll.maxY||e.scroll.moveY<0&&b>0)&&(a(c.scrollContainer).scrollTop(b+e.scroll.moveY),e.draggedItem.css("top",e.draggedItem.offset().top+e.scroll.moveY+1))},10),e.scroll.scrollX=window.setInterval(function(){if(c.scrollContainer!=window)return void a(c.scrollContainer).scrollLeft(a(c.scrollContainer).scrollLeft()+e.scroll.moveX);var b=a(c.scrollContainer).scrollLeft();(e.scroll.moveX>0&&b<e.scroll.maxX||e.scroll.moveX<0&&b>0)&&(a(c.scrollContainer).scrollLeft(b+e.scroll.moveX),e.draggedItem.css("left",e.draggedItem.offset().left+e.scroll.moveX+1))},10),a(d).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),e.setPos(b.pageX,b.pageY),a(document).bind("mousemove",e.swapItems),a(document).bind("mouseup",e.dropItem),c.scrollContainer!=window&&a(window).bind("wheel",e.wheel)},setPos:function(b,d){var f=d-this.offset.top,g=b-this.offset.left;c.dragBetween||(f=Math.min(this.offsetLimit.bottom,Math.max(f,this.offsetLimit.top)),g=Math.min(this.offsetLimit.right,Math.max(g,this.offsetLimit.left)));var h=this.draggedItem.offsetParent().not("body").offset();if(null!=h&&(f-=h.top,g-=h.left),c.scrollContainer==window)d-=a(window).scrollTop(),b-=a(window).scrollLeft(),d=Math.max(0,d-a(window).height()+5)+Math.min(0,d-5),b=Math.max(0,b-a(window).width()+5)+Math.min(0,b-5);else{var i=a(c.scrollContainer),j=i.offset();d=Math.max(0,d-i.height()-j.top)+Math.min(0,d-j.top),b=Math.max(0,b-i.width()-j.left)+Math.min(0,b-j.left)}e.scroll.moveX=0==b?0:b*c.scrollSpeed/Math.abs(b),e.scroll.moveY=0==d?0:d*c.scrollSpeed/Math.abs(d),this.draggedItem.css({top:f,left:g})},wheel:function(b){if(e&&c.scrollContainer!=window){var d=a(c.scrollContainer),f=d.offset();if(b=b.originalEvent,b.clientX>f.left&&b.clientX<f.left+d.width()&&b.clientY>f.top&&b.clientY<f.top+d.height()){var g=(0==b.deltaMode?1:10)*b.deltaY;d.scrollTop(d.scrollTop()+g),b.preventDefault()}}},buildPositionTable:function(){var b=[];this.getItems().not([e.draggedItem[0],e.placeHolderItem[0]]).each(function(c){var d=a(this).offset();d.right=d.left+a(this).outerWidth(),d.bottom=d.top+a(this).outerHeight(),d.elm=this,b[c]=d}),this.pos=b},dropItem:function(){if(null!=e.draggedItem){var b=e.draggedItem.attr("data-origstyle");if(e.draggedItem.attr("style",b),""==b&&e.draggedItem.removeAttr("style"),e.draggedItem.removeAttr("data-origstyle"),e.styleDragHandlers(!0),e.placeHolderItem.before(e.draggedItem),e.placeHolderItem.remove(),a("[data-droptarget], .dragSortItem").remove(),window.clearInterval(e.scroll.scrollY),window.clearInterval(e.scroll.scrollX),e.draggedItem.attr("data-origpos")!=a(d).index(e)+"-"+a(e.container).children().index(e.draggedItem)&&0==c.dragEnd.apply(e.draggedItem)){var f=e.draggedItem.attr("data-origpos").split("-"),g=a(d[f[0]].container).children().not(e.draggedItem).eq(f[1]);g.length>0?g.before(e.draggedItem):0==f[1]?a(d[f[0]].container).prepend(e.draggedItem):a(d[f[0]].container).append(e.draggedItem)}return e.draggedItem.removeAttr("data-origpos"),e.draggedItem=null,a(document).unbind("mousemove",e.swapItems),a(document).unbind("mouseup",e.dropItem),c.scrollContainer!=window&&a(window).unbind("wheel",e.wheel),!1}},swapItems:function(b){if(null==e.draggedItem)return!1;e.setPos(b.pageX,b.pageY);for(var g=e.findPos(b.pageX,b.pageY),h=e,i=0;g==-1&&c.dragBetween&&i<d.length;i++)g=d[i].findPos(b.pageX,b.pageY),h=d[i];if(g==-1)return!1;var j=function(){return a(h.container).children().not(h.draggedItem)},k=j().not(c.itemSelector).each(function(a){this.idx=j().index(this)});return null==f||f.top>e.draggedItem.offset().top||f.left>e.draggedItem.offset().left?a(h.pos[g].elm).before(e.placeHolderItem):a(h.pos[g].elm).after(e.placeHolderItem),k.each(function(){var b=j().eq(this.idx).get(0);this!=b&&j().index(this)<this.idx?a(this).insertAfter(b):this!=b&&a(this).insertBefore(b)}),a(d).each(function(a,b){b.createDropTargets(),b.buildPositionTable()}),f=e.draggedItem.offset(),!1},findPos:function(a,b){for(var c=0;c<this.pos.length;c++)if(this.pos[c].left<a&&this.pos[c].right>a&&this.pos[c].top<b&&this.pos[c].bottom>b)return c;return-1},createDropTargets:function(){c.dragBetween&&a(d).each(function(){var b=a(this.container).find("[data-placeholder]"),d=a(this.container).find("[data-droptarget]");b.length>0&&d.length>0?d.remove():0==b.length&&0==d.length&&("td"==c.tagName?a(c.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):a(this.container).append(e.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",!0)),e.placeHolderItem.attr("data-placeholder",!0))})}};h.init(),d.push(h)}),this},a.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}}(jQuery);